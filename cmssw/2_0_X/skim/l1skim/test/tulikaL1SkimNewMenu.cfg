//
// This job does the following :
//   1. re-run the GT emulator with a new menu
//   2. skim (according to the outcome of the new L1 decision
//        and a definable set of L1 trigger algorithms)
//   3. write out RAW data + the new L1 trigger results
//
//  Note that an HLT job running on the output of this file must
//  be configured to take the L1 decision from the new results
//  NOT from the RAW data, as standard.
//
//  Jim Brooke, 30 April 2008
//


process Raw2 = {

  // Message Logger
  include "FWCore/MessageLogger/data/MessageLogger.cfi"

  // Source of events
  untracked PSet maxEvents = {untracked int32 input = 100000}


  source = PoolSource {
    untracked vstring fileNames = {
    '/store/relval/2008/4/24/relval-TestCSA08MinBias-TESTESTEST-B-204/0001/008EBA5C-F512-DD11-96E9-001731A28675.root'
    }
  }

  // unpack GMT candidates
  include "L1TriggerConfig/L1ScalesProducers/data/L1MuTriggerScalesConfig.cff"
  include "L1TriggerConfig/L1ScalesProducers/data/L1MuGMTScalesConfig.cff"
  module gmtDigis = l1GtUnpack from "EventFilter/L1GlobalTriggerRawToDigi/data/l1GtUnpack.cfi"
  replace gmtDigis.ActiveBoardsMask = 0x0100
  replace gmtDigis.DaqGtInputTag = rawDataCollector

  // unpack GCT candidates
  module gctDigis = l1GctHwDigis from "EventFilter/GctRawToDigi/data/l1GctHwDigis.cfi"
  replace gctDigis.inputLabel = rawDataCollector

  // re-run GT emulator
  include "L1TriggerConfig/L1GtConfigProducers/data/L1GtConfig.cff"
  module newGtDigis = gtDigis from "L1Trigger/GlobalTrigger/data/gtDigis.cfi"

  // menu to use with new GT digis
  include "L1TriggerConfig/L1GtConfigProducers/data/Luminosity/lumi1030/L1Menu2008_2E30.cff"
//  include "L1TriggerConfig/L1GtConfigProducers/data/Luminosity/lumi1x1032/L1Menu2007.cff"

  // L1Extra (needed by skim filter)
  include "L1TriggerConfig/GctConfigProducers/data/L1GctConfig.cff"
  include "L1TriggerConfig/L1ScalesProducers/data/L1CaloScalesConfig.cff"
  include "L1TriggerConfig/L1GeometryProducers/data/l1CaloGeomConfig.cff"
  include "L1Trigger/L1ExtraFromDigis/data/l1extraParticles.cfi"

  // filter based on L1 bits
  module skim = hltLevel1GTSeed from "HLTrigger/HLTfilters/data/hltLevel1GTSeed.cfi"
  replace skim.L1GtReadoutRecordTag = newGtDigis
  replace skim.L1GtObjectMapTag = newGtDigis
  
  replace skim.L1SeedsLogicalExpression =  "L1_SingleJet150 OR L1_DoubleJet70 OR L1_TripleJet50 OR L1_ETM40 OR L1_HTT300 OR L1_ETT60 OR L1_SingleJet100 OR L1_SingleJet70 OR L1_SingleJet30 OR L1_SingleJet15 OR L1_IsoEG10_Jet15_ForJet10 OR L1_SingleIsoEG12 OR L1_SingleEG15 OR L1_DoubleIsoEG8 OR L1_DoubleEG10 OR L1_ExclusiveDoubleIsoEG6 OR L1_SingleIsoEG10 OR L1_SingleMu7 OR L1_DoubleMu3 OR L1_TripleMu3 OR L1_SingleMu3 OR L1_SingleMu5 OR L1_DoubleJet100 OR L1_Mu5_Jet15 OR L1_IsoEG10_Jet20 OR L1_IsoEG10_Jet30 OR L1_Mu3_IsoEG5 OR L1_Mu3_EG12 OR L1_IsoEG10_TauJet20 OR L1_SingleJet50 OR L1_SingleJet200 OR L1_ZeroBias OR L1_MinBias_HTT10 OR L1_Mu5_TauJet20 OR L1_TauJet30_ETM30 OR L1_DoubleTauJet40 OR L1_SingleTauJet80 OR L1_QuadJet30 OR L1_SingleMuBeamHalo OR L1_SingleEG8 OR L1_SingleEG5 OR L1_DoubleEG5 OR L1_SingleTauJet30 OR L1_SingleTauJet40 OR L1_SingleTauJet60 OR L1_SingleJetCountsHFTow OR L1_DoubleJetCountsHFTow OR L1_SingleEG2 OR L1_DoubleEG1 OR L1_SingleJetCountsHFRing0Sum3 OR L1_DoubleJetCountsHFRing0Sum3 OR L1_SingleJetCountsHFRing0Sum6 OR L1_DoubleJetCountsHFRing0Sum6 OR L1_SingleEG10 OR L1_SingleEG12 OR L1_QuadJet15 OR L1_DoubleTauJet20 OR L1_ETM20 OR L1_ETM30 OR L1_ETM50 OR L1_HTT200 OR L1_EG5_TripleJet15 OR L1_Mu3_TripleJet15 OR L1_SingleMuOpen OR L1_SingleMu10"

  path p = { 
             gmtDigis,
             gctDigis,
             newGtDigis,
             l1extraParticles,
             skim
           } 

  include "Configuration/EventContent/data/EventContent.cff"

  module FEVT = PoolOutputModule {
    using FEVTEventContent
    untracked string fileName='file:/uscmst1b_scratch/lpc1/lpctrig/tulika/CSA08-skim/L1SkimRaw.root'
    untracked int32 basketSize = 4096
      untracked PSet dataset ={      
        untracked string dataTier = "RAW"
      }
    untracked PSet SelectEvents = {
      vstring SelectEvents = {"p"}
    }
  }

//drop 1_7_X old RAW and other products
  replace FEVT.outputCommands += "drop *_*_*_*"
  replace FEVT.outputCommands += "keep *_rawDataCollector_*_*"
  replace FEVT.outputCommands += "keep *_gctDigis_*_*"
  replace FEVT.outputCommands += "keep *_gmtDigis_*_*"
  replace FEVT.outputCommands += "keep *_newGtDigis_*_*"

# GT trigger report
  include "L1Trigger/GlobalTriggerAnalyzer/data/l1GtTrigReport.cfi"
  replace l1GtTrigReport.L1GtRecordInputTag = newGtDigis

  endpath e = {FEVT, l1GtTrigReport}

}
