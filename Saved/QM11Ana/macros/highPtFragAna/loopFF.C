#include "TFile.h"
#include "TChain.h"
#include "TCut.h"
#include "TCanvas.h"
#include "TLine.h"
#include "TLegend.h"
#include "TProfile.h"
#include "FFAnaLoop.h"

void loopFF(
    Bool_t doSel=true)
{
  // ===================================
  // Inputs
  // ===================================
  TString infrec="tr_j1f_data.root";
  TString infakrec="tr_j4f_data.root";
  TString infgen="tr_j1f_data.root";
  TChain * trec = new TChain("tjf");
  trec->Add(infrec);
  TChain * aktrec = new TChain("tjf");
  aktrec->Add(infakrec);
  Float_t ptHatMin=80;
  TChain * tgen = new TChain("tjf");
  tgen->Add(infgen);
  TCut evtCut="cent<30";
  cout << infrec << " cut " << TString(evtCut) << ": " << trec->GetEntries(evtCut) << endl;
  cout << infakrec << " cut " << TString(evtCut) << ": " << aktrec->GetEntries(evtCut) << endl;
  cout << infgen << " cut " << TString(evtCut) << ": " << tgen->GetEntries(evtCut) << endl;

  TString tag("CorrUqB2");
  // ===================================
  // Cuts
  // ===================================
  selectionCut cut;
  cut.doSel = doSel;
  cut.CentMin=0;
  cut.CentMax=30;
  cut.JEtMin[0] = 120;
  cut.JEtMax[0] = 250;
  cut.JEtMin[1] = 50;
  cut.JEtMax[1] = 250;
  cut.JEtaMax[0] = 2;
  cut.JEtaMax[1] = 2;
  cut.TrkEtaMax = 2.4;
  cut.ConeSize = 0.5;

  // ===================================
  // Correction
  // ===================================
  Corrector3D trkCorr("trkCorrHisAna_djuqv2","B2");
  trkCorr.ptRebinFactor_ = 1;
  trkCorr.sampleMode_ = 1; // 0 for choosing individual sample, 1 for merge samples
  trkCorr.smoothLevel_ = 1; // 0: no smooth, 1: smooth jet, 2: smooth jet,eta
  trkCorr.Init(0);
  //TH1D * hPtBinUnRebin = (TH1D*)trkCorr.ptBin_->Clone("hPtBinUnRebin");
  //trkCorr.Init(1,"TrkCorr2DB0.root");

  // ===================================
  // Setup
  // ===================================
  // bins
  const Int_t numPPtBins=18;
  Float_t pptBins[numPPtBins+1] = {0.5,1,1.5,2,2.5,3,4,5,7.5,10,12,15,20,25,30,45,60,90,120};
  vector<Double_t> ptBin(pptBins,pptBins+numPPtBins+1);
  //TH1D * hxbin = new TH1D("hxbin","",numPPtBins,pptBins);
  //TH1D * hxbin = (TH1D*)hPtBinUnRebin->Clone("hxbin");
  //TH1D * hxbin = (TH1D*)trkCorr.ptBin_->Clone("hxbin");
  //hxbin->Rebin(2);
  //vector<Double_t> ptBin;
  //for (Int_t i=1; i<=hxbin->GetNbinsX()+1; ++i) {
  //  ptBin.push_back(hxbin->GetBinLowEdge(i));
  //}
  cout << ptBin.size()-1 << " pt bins: ";
  for (Int_t i=0; i<ptBin.size(); ++i) {cout << ptBin[i] << " ";}
  cout << endl;

  // ===================================
  // Analyze
  // ===================================
  TString outName(Form("Ana_%s",tag.Data()));
  if (!cut.doSel) outName+="Nt";
  TString outFileName(Form("histsFragLoop_%s.root",outName.Data()));
  TFile * outf = new TFile(outFileName,"RECREATE");
  // rec trk
  FFAnaLoop recfana("icRec");
  recfana.ptHatMin_ = ptHatMin;
  recfana.anaTrkType_=2;
  recfana.t_ = trec;
  recfana.cut_ = &cut;
  recfana.trkCorr_ = &trkCorr;
  recfana.ptBin_ = ptBin;
  recfana.Init();
  recfana.Loop();

  FFAnaLoop akrecfana("akRec");
  akrecfana.ptHatMin_ = ptHatMin;
  akrecfana.anaTrkType_=2;
  akrecfana.t_ = aktrec;
  akrecfana.cut_ = &cut;
  akrecfana.trkCorr_ = &trkCorr;
  akrecfana.ptBin_ = ptBin;
  akrecfana.Init();
  akrecfana.Loop();
  /*
  // gen partilce
  FFAnaLoop genfana("Gen");
  genfana.ptHatMin_ = ptHatMin;
  genfana.anaTrkType_=0;
  genfana.t_ = tgen;
  genfana.cut_ = &cut;
  genfana.trkCorr_ = &trkCorr;
  genfana.ptBin_ = ptBin;
  genfana.Init();
  genfana.Loop();

  // get ratio
  for (Int_t j=0; j<2; ++j) {
    for (Int_t lv=0; lv<=4; ++lv) {
      recfana.vhPPtRat_[j][lv]->Divide(recfana.vhPPtCorr_[j][lv],genfana.vhPPtCorr_[j][0]);
    }
  }
  */

  // ===================================
  // Plot
  // ===================================
  Int_t colors[10] = {kGray+2,kViolet,kBlue+1,kGreen+2,kOrange+2,kMagenta,kRed};
  for (Int_t j=0; j<2; ++j) {
    TString append(Form("_j%d_%s",j,outName.Data()));
    // draw Xi
    TCanvas *cXiRaw = new TCanvas("cXiRaw"+append,"XiRaw"+append,500,500);
    recfana.vhXi_[j][0]->SetAxisRange(0,3,"Y");
    recfana.vhXi_[j][0]->SetTitle(";#xi=ln(E_{T}^{Jet}/p_{T}^{trk});#frac{1}{N_{jet}} #frac{dN}{d#xi}");
    recfana.vhXi_[j][0]->SetMarkerStyle(kOpenSquare);
    recfana.vhXi_[j][0]->SetMarkerColor(kRed);
    recfana.vhXi_[j][0]->SetLineColor(kRed);
    recfana.vhXi_[j][0]->Draw("E");
    akrecfana.vhXi_[j][0]->Draw("Esame");

    TCanvas *cXi = new TCanvas("cXi"+append,"Xi"+append,500,500);
    recfana.vhXi_[j][4]->SetAxisRange(0,3,"Y");
    recfana.vhXi_[j][4]->SetTitle(";#xi=ln(E_{T}^{Jet}/p_{T}^{trk});#frac{1}{N_{jet}} #frac{dN}{d#xi}");
    recfana.vhXi_[j][4]->SetMarkerStyle(kOpenSquare);
    recfana.vhXi_[j][4]->SetMarkerColor(kRed);
    recfana.vhXi_[j][4]->SetLineColor(kRed);
    recfana.vhXi_[j][4]->Draw("E");
    akrecfana.vhXi_[j][4]->Draw("Esame");
    TLegend *leg = new TLegend(0.55,0.77,0.85,0.92);
    leg->SetFillStyle(0);
    leg->SetBorderSize(0);
    leg->SetTextSize(0.035);
    leg->AddEntry(recfana.vhXi_[j][4],"Corr Trk, Data, icpu5","p");
    leg->AddEntry(akrecfana.vhXi_[j][4],"Corr Trk, Data, ak3pf","p");
    leg->Draw();

    /*
    // prepare histogram frame
    genfana.vhPPtCorr_[j][0]->SetAxisRange(4,100,"X");
    genfana.vhPPtCorr_[j][0]->SetAxisRange(1e-3,5e1,"Y");
    genfana.vhPPtCorr_[j][0]->SetLineColor(kRed);
    genfana.vhPPtCorr_[j][0]->SetMarkerColor(kRed);
    genfana.vhPPtCorr_[j][0]->SetMarkerStyle(kOpenCircle);
    for (Int_t lv=0; lv<=3; ++lv) {
      recfana.vhPPtCorr_[j][lv]->SetMarkerStyle(kOpenSquare);
      recfana.vhPPtCorr_[j][lv]->SetMarkerColor(colors[lv]);
      recfana.vhPPtCorr_[j][lv]->SetLineColor(colors[lv]);
      recfana.vhPPtRat_[j][lv]->SetMarkerStyle(kOpenSquare);
      recfana.vhPPtRat_[j][lv]->SetMarkerColor(colors[lv]);
      recfana.vhPPtRat_[j][lv]->SetLineColor(colors[lv]);
    }

    // draw spectrum
    TCanvas *c2 = new TCanvas("c2"+append,"closure"+append,500,900);
    c2->Divide(1,2);
    c2->cd(1);
    c2->GetPad(1)->SetLogy();
    c2->GetPad(1)->SetLogx();
    genfana.vhPPtCorr_[j][0]->Draw("hist");
    recfana.vhPPtCorr_[j][0]->Draw("sameE");
    for (Int_t lv=1; lv<=4; ++lv) {
      recfana.vhPPtCorr_[j][lv]->Draw("sameE");
    }
    // draw ratio
    c2->cd(2);
    c2->GetPad(2)->SetLogx();
    recfana.vhPPtRat_[j][0]->Draw("E");
    recfana.vhPPtRat_[j][0]->SetAxisRange(4,100,"X");
    recfana.vhPPtRat_[j][0]->SetAxisRange(0,1.5,"Y");
    for (Int_t lv=1; lv<=4; ++lv) {
      recfana.vhPPtRat_[j][lv]->Draw("sameE");
    }

    // ====================
    TLine *l = new TLine(4,1,100,1);
    l->SetLineStyle(2);
    l->Draw();

    TString corrLevelName[5] = { "Raw","Eff","Fake","Mul. Rec","Full" };
    c2->cd(1);
    TLegend *leg = new TLegend(0.61,0.57,0.91,0.91);
    leg->SetFillStyle(0);
    leg->SetBorderSize(0);
    leg->SetTextSize(0.035);
    //leg->AddEntry(genfana.vhPPtCorr_[0][0],"#DeltaR(jet,trk)<0.5","");
    leg->AddEntry(genfana.vhPPtCorr_[0][0],"Gen. Particle","pl");
    for (Int_t lv=0; lv<=4; ++lv) {
      leg->AddEntry(recfana.vhPPtCorr_[j][lv],"Trk Corr. "+corrLevelName[lv],"pl");
    }
    leg->Draw();

    c2->Print(Form("ClosureTrkPt%s.gif",append.Data()));

    // ====================
    TCanvas * chk0 = new TCanvas("chk0"+append,"eff_vs_pt"+append,500,500);
    chk0->SetLogz();
    chk0->SetRightMargin(0.15);
    recfana.vhTrkCorrPPt_[j][1]->Draw("colz");
    recfana.vhTrkCorrPPt_[j][1]->ProfileX()->Draw("same");
    //trkCorr.InspectCorr(0,-1,0,-1,2,7-2,7+2,"histsame");
    chk0->Print(Form("AppliedTrkEffPPt%s.gif",append.Data()));

    TCanvas * chk1 = new TCanvas("chk1"+append,"fake_vs_pt"+append,500,500);
    chk1->SetLogz();
    chk1->SetRightMargin(0.15);
    recfana.vhTrkCorrPPt_[j][2]->Draw("colz");
    recfana.vhTrkCorrPPt_[j][2]->ProfileX()->Draw("same");
    //trkCorr.InspectCorr(1,-1,0,-1,2,7-2,7+2,"histsame");
    chk1->Print(Form("AppliedTrkFakPPt%s.gif",append.Data()));

    TCanvas * cCorrJEt = new TCanvas("cCorrJEt"+append,"eff_vs_jet"+append,500,500);
    cCorrJEt->SetLogz();
    cCorrJEt->SetRightMargin(0.15);
    recfana.vhTrkCorrJEt_[j][1]->Draw("colz");
    recfana.vhTrkCorrJEt_[j][1]->ProfileX()->Draw("same");
    //trkCorr.InspectCorr(0,-1,0,-1,2,7-2,7+2,"histsame");
    cCorrJEt->Print(Form("AppliedTrkEffJEt%s.gif",append.Data()));

    TCanvas * cCorrCent = new TCanvas("cCorrCent"+append,"eff_vs_cent"+append,500,500);
    cCorrCent->SetLogz();
    cCorrCent->SetRightMargin(0.15);
    recfana.vhTrkCorrCent_[j][1]->Draw("colz");
    recfana.vhTrkCorrCent_[j][1]->ProfileX()->Draw("same");
    //trkCorr.InspectCorr(0,-1,0,-1,2,7-2,7+2,"histsame");
    cCorrCent->Print(Form("AppliedTrkEffCent%s.gif",append.Data()));
  */
  }

  // ===================================
  // All Done, Write output if choose
  // ===================================
  //if (!cut.doSel) recfana.jfr_->Write();
  //else outf->Clear();
}
